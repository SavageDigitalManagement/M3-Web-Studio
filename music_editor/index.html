<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>M3 Web Studio — Browser Music Editor</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%230b1116'/%3E%3Cpath d='M14 36c8-10 16-10 24 0 6 8 14 8 12-6' stroke='%2300e5ff' stroke-width='4' fill='none'/%3E%3Ccircle cx='20' cy='24' r='4' fill='%236bffb8'/%3E%3C/svg%3E">
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="brand">
        <div class="logo">M3 WEB STUDIO</div>
        <div class="tag">sleek browser music editor</div>
      </div>
      <div class="transport">
        <button id="playBtn" class="btn primary">Play</button>
        <button id="pauseBtn" class="btn">Pause</button>
        <button id="stopBtn" class="btn">Stop</button>
        <div class="time" id="timeReadout">00:00.0</div>
        <div class="time" id="barBeatReadout">1.1.1</div>
      </div>
      <div class="tools">
        <label class="file">
          <input id="fileInput" type="file" accept="audio/*" multiple />
          Import Audio
        </label>
        <input id="ytUrl" type="text" class="btn hidden" placeholder="YouTube URL" />
        <button id="ripSelectedBtn" class="btn hidden">Rip → Selected</button>
        <button id="ripNewBtn" class="btn hidden">Rip → New Track</button>
        <select id="exportFormat" class="btn">
          <option value="wav">Export WAV</option>
          <option value="webm">Export WebM (Opus)</option>
          <option value="ogg">Export OGG (Opus)</option>
        </select>
        <button id="exportBtn" class="btn">Export</button>
        <button id="addTrack" class="btn">Add Track</button>
        <button id="settingsBtn" class="btn">Settings</button>
      </div>
    </header>

    <section class="studio">
      <aside class="sidebar">
        <div class="panel">
          <div class="panel-title">Tracks</div>
          <div id="mixerSidebar"></div>
        </div>
      </aside>
      <main class="timeline" id="timeline">
        <div class="ruler" id="ruler"></div>
        <div id="rangeSelector" class="range-selector hidden">
          <div class="range-handle left"></div>
          <div class="range-body"></div>
          <div class="range-handle right"></div>
        </div>
        <div class="trackArea" id="trackArea"></div>
        <div class="playhead" id="playhead"></div>
        <div class="ghosthead" id="ghosthead"></div>
      </main>
    </section>
  </div>

  <div class="fx-overlay" aria-hidden="true">
    <div class="fx-scanline"></div>
    <div class="fx-noise"></div>
    <canvas id="fxParticles"></canvas>
  </div>

  <div id="contextMenu" class="context hidden"></div>

  <div id="bottomDrawer" class="bottom-drawer">
    <button id="menuToggle" class="menu-toggle"><span>M3 Menu</span></button>
    <div class="bottom-tabs">
      <button id="tabAudio" class="tab active">Audio</button>
      <button id="tabTracks" class="tab">Tracks</button>
      <button id="tabMixer" class="tab">Mixer</button>
      <button id="tabProject" class="tab">Project</button>
      <button id="tabActions" class="tab">Actions</button>
      <button id="tabEffects" class="tab">Effects</button>
    </div>
    <div class="bottom-panel" id="panelAudio">
    <div id="panelResize" class="panel-resize"></div>
    <div class="panel-title">Selected Clip</div>
    <div class="audio-preview">
      <div>
        <div id="clipName" class="muted">No clip selected</div>
        <div class="mini-controls">
          <label class="toggle">
            <input id="miniFollowToggle" type="checkbox" checked />
            Mini Follow
          </label>
          <button id="audioPlay" class="btn primary">Play</button>
          <button id="audioPause" class="btn">Pause</button>
          <button id="audioStop" class="btn">Stop</button>
          <button id="audioSplit" class="btn">Split</button>
          <button id="audioDuplicate" class="btn">Duplicate</button>
          <button id="audioDelete" class="btn">Delete</button>
        </div>
      </div>
      <div id="previewWrap" class="preview-wrap">
        <div id="previewPlayhead" class="preview-playhead"></div>
        <canvas id="clipPreview" width="1200" height="120"></canvas>
      </div>
    </div>
  </div>
    <div class="bottom-panel hidden" id="panelMixer">
    <div class="panel-title">Track EQ + Filters</div>
    <div id="eqControls" class="eq-grid"></div>
  </div>
    <div class="bottom-panel hidden" id="panelTracks">
      <div class="panel-title">Tracks</div>
      <div id="mixerPanel"></div>
    </div>
    <div class="bottom-panel hidden" id="panelProject">
    <div class="panel-title">Project</div>
    <div class="project-info">
      <div><span>Tempo</span><strong id="tempoValue">120</strong></div>
      <div><span>Key</span><strong>—</strong></div>
      <div><span>Length</span><strong id="projectLen">0.0s</strong></div>
    </div>
    <div class="project-actions">
      <div class="project-row">
        <button id="saveProjectFile" class="btn">Save Project File</button>
        <button id="loadProjectFile" class="btn">Load Project File</button>
        <input id="projectFileInput" type="file" accept=".m3proj,application/json" class="hidden" />
      </div>
      <div class="project-row">
        <label class="toggle">
          <input id="includeAudioInFile" type="checkbox" checked />
          Include audio in file
        </label>
      </div>
      <div class="project-row">
        <button id="saveProjectLocal" class="btn">Save to Browser</button>
        <button id="loadProjectLocal" class="btn">Load from Browser</button>
        <button id="clearProjectLocal" class="btn">Clear Local</button>
      </div>
      <div id="projectStatus" class="hint muted">Project saves are local unless you export a file.</div>
    </div>
  </div>
    <div class="bottom-panel hidden" id="panelActions">
    <div class="panel-title">Actions</div>
    <button id="splitBtn" class="btn">Split at Playhead</button>
    <button id="duplicateBtn" class="btn">Duplicate Clip</button>
    <button id="deleteBtn" class="btn">Delete Clip</button>
    <div class="hint">Select a clip to edit. Drag clips on the timeline.</div>
  </div>
    <div class="bottom-panel hidden" id="panelEffects">
    <div class="panel-title">Effects</div>
    <div class="effects-actions">
      <button id="fxFadeIn" class="btn">Fade In Selection…</button>
      <button id="fxFadeOut" class="btn">Fade Out Selection…</button>
      <button id="fxCrossfade" class="btn">Crossfade Selection…</button>
    </div>
    <div class="hint muted">Tip: Alt + drag on the timeline to create a selection range.</div>
    <div class="effects-grid">
      <div class="effects-section">
        <div class="panel-title">Clip FX (Selected Clip)</div>
        <div class="effect-row">
          <label>Time Stretch</label>
          <input id="clipRate" type="range" min="0.5" max="2" step="0.01" value="1" />
          <span id="clipRateVal" class="muted">1.00x</span>
        </div>
        <div class="effect-row">
          <label>Pitch</label>
          <input id="clipPitch" type="range" min="-12" max="12" step="1" value="0" />
          <span id="clipPitchVal" class="muted">0 st</span>
        </div>
        <div class="effect-row">
          <button id="clipFxApply" class="btn">Apply Stretch</button>
          <button id="clipFxReset" class="btn">Reset Clip FX</button>
        </div>
        <div class="hint muted">Time Stretch is granular and keeps pitch. Pitch shifts by resampling.</div>
      </div>
      <div class="effects-section">
        <div class="panel-title">Track FX (Selected Track)</div>
        <div class="effect-row">
          <label><input id="fxDelayOn" type="checkbox" /> Delay</label>
          <input id="fxDelayTime" type="range" min="0" max="0.8" step="0.01" value="0.2" />
          <input id="fxDelayFeedback" type="range" min="0" max="0.9" step="0.01" value="0.3" />
          <input id="fxDelayMix" type="range" min="0" max="1" step="0.01" value="0.25" />
        </div>
        <div class="effect-row">
          <label><input id="fxReverbOn" type="checkbox" /> Reverb</label>
          <input id="fxReverbMix" type="range" min="0" max="1" step="0.01" value="0.2" />
        </div>
        <div class="effect-row">
          <label><input id="fxSatOn" type="checkbox" /> Saturation</label>
          <input id="fxSatDrive" type="range" min="0" max="1" step="0.01" value="0.2" />
        </div>
        <div class="effect-row">
          <label><input id="fxCompOn" type="checkbox" /> Compressor</label>
          <input id="fxCompThreshold" type="range" min="-60" max="0" step="1" value="-18" />
          <input id="fxCompRatio" type="range" min="1" max="20" step="0.5" value="4" />
        </div>
      </div>
    </div>
  </div>

  </div>

    <div id="settingsHud" class="hud hidden">
      <div class="hud-header">
        <div class="hud-title">M3 Settings</div>
        <button id="closeHud" class="btn">Close</button>
      </div>
      <div class="hud-grid">
      <label>BPM
        <input id="bpmInput" type="number" min="40" max="220" value="120" />
      </label>
      <label>Snap to Beat
        <input id="snapToggle" type="checkbox" checked />
      </label>
      <label>Auto-Scroll
        <input id="followToggle" type="checkbox" checked />
      </label>
      <label>Beat Grid
        <select id="gridSelect">
          <option value="1">1/1</option>
          <option value="2">1/2</option>
          <option value="4" selected>1/4</option>
          <option value="8">1/8</option>
          <option value="16">1/16</option>
        </select>
      </label>
      <input id="analysisUrl" type="hidden" />
      <label>Metronome
        <input id="metroToggle" type="checkbox" />
      </label>
      <label>FX Intensity
        <input id="fxIntensity" type="range" min="0" max="100" value="35" />
      </label>
      <label>Screen Noise
        <input id="fxNoiseToggle" type="checkbox" checked />
      </label>
      <label>Frame Glow
        <input id="fxGlowToggle" type="checkbox" checked />
      </label>
      <label>Zoom
        <input id="zoomHud" type="range" min="5" max="100000" value="120" />
      </label>
      <input id="zoom" type="range" min="5" max="100000" value="120" class="hidden" />
      </div>
      <div class="hud-hint">
        Hotkeys: Space Play/Pause · S Split · D Duplicate · Del Delete · +/- Zoom
      </div>
      <div class="hud-guide">
        <details>
          <summary>Desktop Guide</summary>
          <div class="guide-text">
            Import audio, click a clip to select, drag to move. Right-click for split/duplicate/analyze or selection effects.
            Use the bottom tabs to switch panels. Scroll the timeline to add more space.
            <div class="guide-section">
              <strong>Timeline + Selection</strong>
              <div>Alt + drag: create a range selection</div>
              <div>/ : toggle range selector visibility</div>
              <div>Shift + click: place playhead without snapping</div>
              <div>Drag on empty timeline: pan view</div>
              <div>Space + drag: pan view (grab)</div>
              <div>Shift + mouse wheel: zoom timeline</div>
              <div>Ctrl + wheel: horizontal scroll (timeline) / scroll panels under cursor</div>
            </div>
            <div class="guide-section">
              <strong>Transport</strong>
              <div>Space: play/pause</div>
              <div>, : jump to start</div>
            </div>
            <div class="guide-section">
              <strong>Clips</strong>
              <div>S: split at playhead</div>
              <div>D: duplicate</div>
              <div>Delete / Backspace: delete</div>
              <div>Ctrl + X: cut</div>
              <div>Ctrl + V: paste at playhead</div>
              <div>Ctrl + ← / →: select previous/next clip on track</div>
              <div>Alt + ← / →: nudge clip by grid</div>
              <div>Alt + Shift + ← / →: fine nudge (0.01s)</div>
              <div>Alt + ↑ / ↓: move clip to track above/below</div>
            </div>
            <div class="guide-section">
              <strong>Tracks</strong>
              <div>↑ / ↓: select track</div>
            </div>
            <div class="guide-section">
              <strong>Edit History</strong>
              <div>Ctrl + Z: undo</div>
              <div>Ctrl + Shift + Z or Ctrl + Y: redo</div>
            </div>
            <div class="guide-section">
              <strong>Project Save/Load</strong>
              <div>Project tab → Save Project File (exports .m3proj)</div>
              <div>Project tab → Save to Browser (local)</div>
              <div>Load Project File prompts relink if audio is missing</div>
            </div>
            <div class="guide-section">
              <strong>Effects</strong>
              <div>Effects tab → fade selection / track FX</div>
              <div>Right‑click with range active shows selection effects</div>
            </div>
            <div class="guide-section">
              <strong>Selection Effects</strong>
              <div>Alt + drag to define a range, then use Effects tab or right‑click</div>
              <div>Fade In/Out affects only the selected range (clips auto‑split)</div>
              <div>Crossfade applies fade‑in + fade‑out on the selection boundaries</div>
            </div>
            <div class="guide-section">
              <strong>Clip FX</strong>
              <div>Time Stretch: granular, preserves pitch (Apply to bake)</div>
              <div>Pitch: semitone shift (resampling)</div>
              <div>Reset Clip FX restores original buffer</div>
            </div>
            <div class="guide-section">
              <strong>Track FX</strong>
              <div>Delay: time/feedback/mix</div>
              <div>Reverb: mix</div>
              <div>Saturation: drive</div>
              <div>Compressor: threshold/ratio</div>
              <div>Track FX apply in playback and export</div>
            </div>
            <div class="guide-section">
              <strong>Relink Flow</strong>
              <div>If a project loads without audio, the Relink window appears</div>
              <div>Select the original audio files to restore clips</div>
            </div>
          </div>
        </details>
        <details>
          <summary>Mobile Guide</summary>
          <div class="guide-text">
            Pinch to zoom the timeline, drag to pan. Tap the M3 Menu bar to open/close the drawer.
            Use bottom tabs for Audio/Tracks/Mixer/Project/Actions/Effects.
            <div class="guide-section">
              <strong>Gestures</strong>
              <div>Pinch: zoom timeline</div>
              <div>Drag: pan timeline</div>
              <div>Tap clip: select</div>
              <div>Tap empty grid: move playhead</div>
            </div>
          </div>
        </details>
      </div>
    </div>

  <div id="analysisOverlay" class="overlay hidden">
    <div class="overlay-card">
      <div class="overlay-title">Analyzing BPM + Key…</div>
      <div class="overlay-sub">This can take a few seconds on longer files.</div>
      <div class="progress">
        <div id="analysisProgress" class="progress-bar"></div>
      </div>
    </div>
  </div>

  <div id="effectOverlay" class="overlay hidden">
    <div class="overlay-card effect-card">
      <div class="overlay-title" id="effectTitle">Apply Effect</div>
      <div class="overlay-sub">Applies to the current selection range.</div>
      <div class="hud-grid effect-grid">
        <label>Effect
          <select id="effectType">
            <option value="fadeIn">Fade In</option>
            <option value="fadeOut">Fade Out</option>
            <option value="crossfade">Crossfade</option>
          </select>
        </label>
        <label>Duration (sec)
          <input id="effectDuration" type="number" min="0.05" step="0.05" value="0.5" />
        </label>
        <label>Curve
          <input id="effectCurve" type="range" min="0" max="1" step="0.01" value="0.5" />
        </label>
      </div>
      <div class="effect-actions">
        <button id="effectApply" class="btn primary">Apply</button>
        <button id="effectCancel" class="btn">Cancel</button>
      </div>
    </div>
  </div>

  <div id="relinkOverlay" class="overlay hidden">
    <div class="overlay-card effect-card">
      <div class="overlay-title">Relink Audio Files</div>
      <div class="overlay-sub">Some clips are missing audio. Select the original files to relink.</div>
      <div id="relinkList" class="relink-list"></div>
      <input id="relinkInput" type="file" multiple accept="audio/*" />
      <div class="effect-actions">
        <button id="relinkApply" class="btn primary">Relink</button>
        <button id="relinkSkip" class="btn">Skip Missing</button>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
</body>
</html>
